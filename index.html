<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>MQTT & «Parser Combinators»</title>

    <meta name="description" content="Les bases de SSL et TLS">
    <meta name="author" content="Frédéric Cabestre">

    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/solarized.css" id="theme">
    <link rel="stylesheet" href="myAssets/css/transparents.css">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? 'css/print/pdf.css' : 'css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>

<div class="reveal">

    <div class="slides">
        <section>
            <h1><span class="orange">MQTT</span></p><span class="green">&</span></span></p><span class="blue">Parser Combinators</span></h1>
        </section>

        <section>
            <h2>
                Qui suis-je ?
            </h2>
            <ul>
                <span class="fragment">
                    <li>Un développeur</li>
                    <li>(Mise en œuvre des) langages</li>
                    <li style="margin-bottom:32px">Systèmes (distribués)</li>
                </span>

                <span class="fragment">
                    <li>Telelogic - atelier de génie logiciel</li>
                    <li> - Plateforme de «Grid computing»</li>
                    <li style="margin-bottom:32px">OVH - PaaS IoT</li>
                </span>

                <span class="fragment">
                    <li><img src="myAssets/images/github.svg" style="background-color:#181717; margin-bottom:0; margin-top:0; height:32px"> @fcabestre</li>
                    <li><img src="myAssets/images/twitter.svg" style="background-color:#55ACEE; margin-bottom:0; margin-top:0; height:32px"> https://github.com/fcabestre</li>
                </span>
            </ul>
        </section>

        <section>
            <h2>
                Au menu aujourd'hui
            </h2>
            <ul>
                <span class="fragment">
                    <li>Une librairie MQTT open-source</li>
                </span>

                <span class="fragment">
                    <li>Des «parser combinators»</li>
                </span>

                <span class="fragment">
                    <li>Du Scala</li>
                </span>

                <span class="fragment">
                    <li>Des codeur/décodeurs binaires</li>
                </span>

                <span class="fragment">
                    <li>Une brêve apparition de Rust</li>
                </span>
            </ul>
        </section>

        <section>
            <img src="myAssets/images/SMQTTL.png"/>
        </section>

        <section>
            <h2>
                Encore une bibliothèque MQTT !
            </h2>
            <ul>
                <span class="fragment">
                    <li>Déjà plus de 70 (<span class="blue">mqtt.github.io</span>)</li>
                </span>

                <span class="fragment">
                    <li>Java (7), C (5), Elixir, Haskell, Dart...</li>
                </span>

                <span class="fragment">
                    <li>Scala + Akka</li>
                </span>
                <span class="fragment">
                    <li>Spécification simple</li>
                </span>
            </ul>
        </section>

        <section>
            <h2>
                Et donc... MQTT
            </h2>
            <ul>
                <span class="fragment"><li><span class="blue">M</span>essage <span class="blue">Q</span>ueuing <span class="blue">T</span>elemetry <span class="blue">T</span>ransport</li></span>
                <span class="fragment"><li>Publish/Subscribe</li></span>
                <span class="fragment"><li>TCP</li></span>
                <span class="fragment"><li>Né en 1999</li></span>
                <span class="fragment">
                    <li>Andy Stanford-Clark (IBM)</li>
                    <li>Arlen Nipper (EuroTech)</li>
                </span>
                <span class="fragment"><li>Depuis 2014 Standard OASIS</li></span>
                <span class="fragment"><li>Dernière version 3.1.1</li></span>
            </ul>

        </section>

        <section>
            <img src="myAssets/images/2782960.jpg"/>
        </section>

        <section>
            <img src="myAssets/images/klang2.png"/>
        </section>

        <section>
            <img src="myAssets/images/Vasters.png"/>
        </section>

        <section>
            <h2>
                Critiques
            </h2>
            <ul>
                <span class="fragment"><li>Spécification imprécise...</li></span>
                <span class="fragment"><li>... En amélioration</li></span>
                <span class="fragment"><li>Paradoxes</li></span>
                <span class="fragment"><li>Gaspillages</li></span>
                <span class="fragment"><li>Qualité de service</li></span>
            </ul>
        </section>

        <section>
            <h2>
                Trames et décodeurs
            </h2>
            <ul>
                <span class="fragment"><li>Protocole ⇒ Messages</li></span>
                <span class="fragment"><li>Trames binaires</li></span>
                <span class="fragment"><li>Codecs</li></span>
                <span class="fragment"><li><span class="orange">Codage fastidieux</span></li></span>
            </ul>

        </section>

        <section>
            <h2>
                Digression : Parser Combinators
            </h2>
            <ul>
                <span class="fragment"><li>Frost & Launchburry, 1989</li></span>
                <span class="fragment"><li>"x * 3.14" ?</li></span>
                <span class="fragment"><li>Analyse syntaxique</li></span>
                <span class="fragment"><li>Interpréter {x} {*} {3.14}" ?</li></span>
                <span class="fragment"><li>Fonctions d'ordre supérieur</li></span>
                <span class="fragment"><li><span class="green">Kombi</span> : <span class="orange">Parser</span> x <span class="orange">Parser</span> ⇒ <span class="orange">Parser</span></li></span>
            </ul>
        </section>
        <section>
            <img src="myAssets/images/combine.jpg"/>
        </section>

        <section>
            <img src="myAssets/images/Scodec.png"/>
        </section>

        <section>
            <h2>
                Scodec
            </h2>
            <ul>
                <span class="fragment"><li>Michael Pilquist (<span class="blue">@mpilquist</span>)</li></span>
                <span class="fragment"><li><span class="green">scodec-bits</span></li></span>
                <span class="fragment"><li>Types de base : <span class="orange">BitVector</span> et <span class="orange">ByteVector</span></li></span>
                <span class="fragment"><li><span class="green">scodec-core</span></li></span>
                <span class="fragment"><li>Codecs de base : <span class="green">uint16</span>, <span class="green">bool</span>, <span class="green">utf8</span>...</li></span>
                <span class="fragment"><li>Combinateurs : <span class="green">>>~</span>, <span class="green">~</span>,...</li></span>
            </ul>

        </section>

        <section>
            <h2>
                Exemples simples
            </h2>
            <span class="fragment">
                <pre><code class="scala" data-trim style="font-size: 16px;">
val qosCodec = uint2
val keepAliveCodec = uint16
val stringCodec = variableSizeBytes(uint16, utf8)
                </code></pre>
            </span>
            <span class="fragment">
                <pre><code class="scala" data-trim style="font-size: 16px;">
val headerCodec = (bool :: qosCodec :: bool).as[Header]
                </code></pre>
            </span>
            <span class="fragment">
                <pre><code class="scala" data-trim style="font-size: 16px;">
/**
* This is the, once for all encoded, protocol name [MQIsdp] and protocol version [3]
*/
val connectVariableHeaderFixedBytes: BitVector = BitVector(hex"00064D514973647003")

val connectVariableHeaderCodec = (
    constant(connectVariableHeaderFixedBytes) :~>:
        bool :: bool :: bool :: qosCodec ::
        bool :: bool :: ignore(1) :~>: keepAliveCode
).as[ConnectVariableHeader]
                </code></pre>
            </span>
        </section>

        <section>
            <h2>
                Un peu plus complexe
            </h2>
            <pre><code class="scala" data-trim style="font-size: 16px;">
val discriminator: Discriminator[Frame, ConnectFrame, Int] =
            Discriminator(1)

val codec: Codec[ConnectFrame] =

   (headerCodec :: variableSizeBytes(remainingLengthCodec,
    connectVariableHeaderCodec >>:~ { (hdr: ConnectVariableHeader) ⇒
    stringCodec ::
    conditional(hdr.willFlag, stringCodec) ::
    conditional(hdr.willFlag, stringCodec) ::
    conditional(hdr.userNameFlag, stringCodec) ::
    conditional(hdr.passwordFlag, stringCodec)

})).as[ConnectFrame]
            </code></pre>
        </section>


        <section>
            <pre><code class="scala" data-trim style="font-size: 16px;">
final class RemainingLengthCodec extends Codec[Int] {

    val MinValue = 0
    val MaxValue = 268435455

    def sizeBound = SizeBound.bounded(8, 32)

    def decode(bits: BitVector): Attempt[DecodeResult[Int]] = {
        @annotation.tailrec
        def decodeAux(step: Attempt[DecodeResult[Int]], factor: Int, depth: Int, value: Int): Attempt[DecodeResult[Int]] =
            if (depth == 4) failure(Err("The remaining length must be 4 bytes long at most"))
            else step match {
                case f: Failure ⇒ f
                case Successful(d) ⇒
                if ((d.value & 128) == 0) successful(DecodeResult(value + (d.value & 127) * factor, d.remainder))
                else decodeAux(uint8.decode(d.remainder), factor * 128, depth + 1, value + (d.value & 127) * factor)
            }
        decodeAux(uint8.decode(bits), 1, 0, 0)
    }

    def encode(value: Int): Attempt[BitVector] = {
        @annotation.tailrec
        def encodeAux(value: Int, digit: Int, bytes: ByteVector): ByteVector =
            if (value == 0) bytes :+ digit.asInstanceOf[Byte]
            else encodeAux(value / 128, value % 128, bytes :+ (digit | 0x80).asInstanceOf[Byte])
            if (value < MinValue || value > MaxValue) failure(Err(s"The remaining length must be in the range [$MinValue..$MaxValue], $value is not valid"))
            else successful(BitVector(encodeAux(value / 128, value % 128, ByteVector.empty)))
    }
}
            </code></pre>
        </section>

        <section>
            <img class="cachet" src="myAssets/images/cachets.png"/>
        </section>

        <section>
            <h2>
                Usages
            </h2>
            <ul>
                <span class="fragment"><li>Exemples UDP, MPEG, libpcap</li></span>
                <span class="fragment"><li>Brendan McAdams, <span class="green">HammerSmith</span></li></span>
                <span class="fragment"><li>Verizon, <span class="green">Remotely</span></li></span>
                <span class="fragment"><li>Travis Brown, <span class="green">Finagle</span> </li></span>
            </ul>
        </section>

        <section>
            <h2>
                Scala ! Soyons sérieux !
            </h2>
            <ul>
                <span class="fragment"><li>Complexité & Lourdeur</li></span>
                <span class="fragment"><li>Embarqué, oui mais...</li></span>
                <span class="fragment"><li>... Infrastructures aussi</li></span>
                <span class="fragment"><li>Ce n'est pas que Scala</li></span>
            </ul>
        </section>

        <section>
            <h2>
                Rust à la rescousse
            </h2>
            <ul>
                <span class="fragment"><li>Devoxx 2015</li></span>
                <span class="fragment"><li>Geoffroy Croupie (<span class="blue">@gcroupie</span>)</li></span>
                <span class="fragment"><li><span class="green">De l'API au protocole</span></li></span>
                <span class="fragment"><li>Rust</li></span>
                <span class="fragment"><li><span class="orange">Nom</span></li></span>
            </ul>
        </section>

        <section>
            <img src="myAssets/images/Nom.png"/>
        </section>
    </div>
</div>

<script src="lib/js/head.min.js"></script>
<script src="js/reveal.js"></script>

<script>

    // Full list of configuration options available at:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
        controls: false,
        progress: false,
        history: true,
        center: true,

        transition: 'none', // none/fade/slide/convex/concave/zoom

        math: {
            mathjax: 'https://cdn.mathjax.org/mathjax/latest/MathJax.js',
            config: 'TeX-AMS_HTML-full'  // See http://docs.mathjax.org/en/latest/config-files.html
        },

        // Optional reveal.js plugins
        dependencies: [
            { src: 'plugin/math/math.js', async: true },
            {
                src: 'lib/js/classList.js', condition: function () {
                return !document.body.classList;
            }
            },
            {
                src: 'plugin/markdown/marked.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: 'plugin/markdown/markdown.js', condition: function () {
                return !!document.querySelector('[data-markdown]');
            }
            },
            {
                src: 'plugin/highlight/highlight.js', async: true, condition: function () {
                return !!document.querySelector('pre code');
            }, callback: function () {
                hljs.initHighlightingOnLoad();
            }
            },
            {src: 'plugin/zoom-js/zoom.js', async: true},
            {src: 'plugin/notes/notes.js', async: true}
        ]
    });

</script>

</body>
</html>
